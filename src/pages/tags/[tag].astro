---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);
  const tags = new Set<string>();
  for (const post of allPosts) {
    for (const tag of post.data.tags) {
      tags.add(tag);
    }
  }
  return [...tags].map(tag => ({
    params: { tag },
    props: { tag },
  }));
}

const { tag } = Astro.props;
const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const filtered = allPosts
  .filter(post => post.data.tags.includes(tag))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Group filtered posts by year
const byYear = new Map<string, typeof filtered>();
for (const post of filtered) {
  const year = post.data.date.getFullYear().toString();
  if (!byYear.has(year)) byYear.set(year, []);
  byYear.get(year)!.push(post);
}

// All tags for navigation
const tagCounts = new Map<string, number>();
for (const post of allPosts) {
  for (const t of post.data.tags) {
    tagCounts.set(t, (tagCounts.get(t) || 0) + 1);
  }
}
const sortedTags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1]);

// Date range
const oldest = filtered[filtered.length - 1]?.data.date;
const newest = filtered[0]?.data.date;
const yearRange = oldest && newest
  ? oldest.getFullYear() === newest.getFullYear()
    ? `${newest.getFullYear()}`
    : `${oldest.getFullYear()} - ${newest.getFullYear()}`
  : '';
---

<BaseLayout title={`#${tag}`} description={`Like a Silicon Valley - 「${tag}」に関する記事一覧`}>
  <!-- Header -->
  <div class="mb-8">
    <a href="/tags" class="inline-flex items-center gap-1 text-sm text-gray-400 dark:text-gray-500 hover:text-gp-600 dark:hover:text-neon-sky transition-colors mb-4">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
      </svg>
      All Tags
    </a>

    <div class="flex items-center gap-3 mb-2">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        #{tag}
      </h1>
      <div class="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-white/10 to-transparent"></div>
    </div>

    <div class="flex items-center gap-4 text-sm text-gray-400 dark:text-gray-500 font-mono">
      <span>{filtered.length} articles</span>
      {yearRange && (
        <>
          <span class="w-px h-3 bg-gray-200 dark:bg-white/10"></span>
          <span>{yearRange}</span>
        </>
      )}
    </div>
  </div>

  <!-- Other Tags (horizontal scroll) -->
  <div class="mb-10 -mx-4 px-4 overflow-x-auto">
    <div class="flex gap-2 pb-2">
      {sortedTags.map(([t, count]) => (
        <a
          href={`/tags/${t}`}
          class:list={[
            'inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-full text-sm font-medium transition-all duration-300 whitespace-nowrap shrink-0',
            t === tag
              ? 'bg-gradient-to-r from-neon-sky to-gp-600 text-white shadow-glow'
              : 'glass hover:shadow-glow text-gray-700 dark:text-gray-300 hover:text-gp-600 dark:hover:text-neon-sky',
          ]}
        >
          #{t}
          <span class:list={[
            'text-xs',
            t === tag ? 'text-white/70' : 'text-gray-400 dark:text-gray-500',
          ]}>
            ({count})
          </span>
        </a>
      ))}
    </div>
  </div>

  <!-- Posts grouped by year -->
  <div class="space-y-10">
    {[...byYear.entries()].map(([year, posts]) => (
      <section>
        <div class="flex items-center gap-3 mb-4">
          <h2 class="text-lg font-bold gradient-text">{year}</h2>
          <span class="text-xs font-mono text-gray-400 dark:text-gray-500">({posts.length})</span>
          <div class="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-white/10 to-transparent"></div>
        </div>
        <div class="grid gap-4">
          {posts.map(post => (
            <PostCard
              title={post.data.title}
              date={post.data.date}
              description={post.data.description}
              tags={post.data.tags}
              slug={post.slug}
              source={post.data.source}
            />
          ))}
        </div>
      </section>
    ))}
  </div>
</BaseLayout>
