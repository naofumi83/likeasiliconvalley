---
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostCard from '../components/PostCard.astro';
import Pagination from '../components/Pagination.astro';
import { getCollection } from 'astro:content';
import { tagUrl } from '../utils/tags';

export const getStaticPaths = (async ({ paginate }) => {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);
  const sorted = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
  return paginate(sorted, { pageSize: 5 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;

const allPosts = await getCollection('posts', ({ data }) => !data.draft);
const tagCounts = new Map<string, number>();
for (const post of allPosts) {
  for (const tag of post.data.tags) {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
  }
}
const topTags = [...tagCounts.entries()].sort((a, b) => b[1] - a[1]).slice(0, 8);
const totalPosts = allPosts.length;

// 人気の記事（16記事からランダム5記事を選択）
const popularArticles = [
  { slug: '2015-06-21-entrepreneur-work-life-with-family', title: '家族がいる起業家の働き方', image: 'https://64.media.tumblr.com/b826e881973f836f0e7fe20f0269e2a3/tumblr_inline_p7jzcae3YN1r9qu45_540.jpg' },
  { slug: '2014-06-29-farewell-to-first-staff', title: '未経験者から入ったスタッフの門出', image: 'https://64.media.tumblr.com/c9bc38f22d08d401f0f3095bdbb62671/tumblr_inline_n7w2yxEjAq1r9qu45.jpg' },
  { slug: '2011-04-13-meeting-people-in-sf', title: '色んな人にサンフランシスコで出会った日', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEh9Gy_w24IlKE3pkIO2XFFd5-cVhUVof2s9TUwZ0vThlzR61Z6Y_YiqcmbyZJ4CkSe_2Mu_16uvyoI4ifGgtOUPQaEHJp91ErtrWXTgh9ObYBDm3VR2Lk8ksO3d8mi8s14phDCOpRTArLs5/s320/IMG_3033.jpg' },
  { slug: '2012-09-03-one-year-since-founding', title: '起業して一年が経ちました', image: 'https://64.media.tumblr.com/9583d570ffc82c0357fe8acb7c5068bc/d69b3cf4c3b28478-d2/s540x810/1bc3f067fbe7734f0739661ca62b2cfa4085cdcf.png' },
  { slug: '2011-06-30-reflecting-on-3-months-in-sf', title: '3ヶ月間のサンフランシスコ生活を振り返り', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgHgcajhvjRtQAObDZkSBKZzLDxLtGXYwuSabrFG-OSguCGDiExOuhYpi_5PjHNFWpHU8lU65uCseIeoHhn8M4ydoGSpGW6lo-6QP1nEkdJHBCQox0Am-Mc24oC2jUOdaIws1Px9IMlzitq/s400/iPhoto-7.jpg' },
  { slug: '2011-06-02-discovering-yazawa-in-sf', title: 'まさかサンフランシスコで矢沢永吉を知るとは', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgbJLoM7s4RpgkVrWqTtV0tZVNJ-lVM_CrnPM957BAHaIrFvc9TKgp6GAxdHG2zYzd81G5DiDlz1hw9j80aLDwOdTnW0fAiRLADe7AwcbCUaxkyD8lCuMm9ZQzbVoksAST5y_oAzNu_5rh7/s400/200908-02-78-c0193278_18334226.jpg' },
  { slug: '2011-05-16-trying-uber-car-service', title: 'ちょっとリッチなハイヤーサービスUberを使ってみた', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEicYD0Q9FXbx6Oi-15fUbt3nkgSYBpZSTmEGiD3s9atFsT3TR1bQwXB4m8y4c1CGA3NRaGUxjuY__EEvk9LFZvDToRcSpJJPQ5ThCgXcpTVEZ2jkSWDi0C8BI3_4xKwP1QFj0rBcvheUSmP/s400/Uber.jpg' },
  { slug: '2011-04-25-ideal-office-for-entrepreneurs', title: '起業家にとっての理想のオフィス環境とは', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiXIgFCRWjcXqbnUxsbyWlgfbsyEGuitgaoTF6kifSUl4SRgvRdpkjKltRzWb0T6bICEF27zy_ucvVGVq2v4iaVq15LXltWBlCEjvyH3G9SvhKFNR_KIi-1DER83l6DuVIqDMZ07b92rY5c/s400/IMG_3124.JPG' },
  { slug: '2011-04-12-apartment-hunting-in-sf', title: 'サンフランシスコの家探しで学んだこと', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgCiIO7nOGvPmvZGu2vCTXSXOVhRCKjuQyP927-xt94HYMFXz-U1lm7cVtG-GVPGvld708QrzSd8qGBzEamtkw-pYu2WDllvT7d4dt4XoniBpsfpVb4Y2BvWGmqAPqHBdGJuiVsnb6Kn4HT/s400/iPhoto.jpg' },
  { slug: '2015-02-01-first-employee-graduates', title: 'グッドパッチ第1号社員の卒業', image: 'https://64.media.tumblr.com/8a65aef510b14d94d80f95d4eba5eb58/tumblr_inline_p83m5fu3841r9qu45_540.jpg' },
  { slug: '2016-12-31-looking-back-at-2016', title: '2016年を振り返る', image: 'https://64.media.tumblr.com/9ce7235ab5f2aace54221fa91923f65f/tumblr_inline_oj1v3x7zFd1r9qu45_540.jpg' },
  { slug: '2016-02-03-office-with-kitchen', title: 'キッチンのあるオフィス', image: 'https://64.media.tumblr.com/9fae3ce23dfff7821f7acc3acf70901e/tumblr_inline_o1zlvqMD1G1r9qu45_540.jpg' },
  { slug: '2015-12-31-looking-back-at-2015', title: '2015年を振り返る', image: 'https://64.media.tumblr.com/c20d1b6bee1e2964869a60df060a30f7/tumblr_inline_o083isnkQY1r9qu45_540.jpg' },
  { slug: '2015-05-17-why-we-opened-berlin-office', title: 'ベルリンにオフィスを出した理由', image: 'https://64.media.tumblr.com/c925ed3b90f929da0068e1741ad0169d/tumblr_inline_noi3zdgxPx1r9qu45_540.jpg' },
  { slug: '2012-07-08-thoughts-on-gunosy', title: 'Gunosyというサービスに関わって思うこと', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEghZ4dxEV3OHaCGFuuLBWeNVRq5wFepBTfB5tyoFGQbT0teuonhjOU3HTnkmBZ2B1QFWI7258KF34higR-wyJkW4c8t2kHo0h8TPdcWgHU8ASpMWg91ZhvlTSJsglmdXFhmp4ccKTnLCxyZ/s640/Gunosy%EF%BC%88%E3%82%AF%E3%82%99%E3%83%8E%E3%82%B7%E3%83%BC%EF%BC%89.png' },
  { slug: '2011-08-04-logo-business-founding-members', title: 'ロゴと事業と創業メンバーとパーティーなど', image: 'https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2ygR3oCtuf-Bu8JGqJ-fxyITdxO9QStYbPqPFU_ZW_ABu7bBVLR05vFRmzuSCv_fS3Gtn8JYUAW7UurTQ4VnoCiMD4pmQFdA0Fg1MDmR2lUhIvekPjgXbJo0Fu6jn22CMmO3UMwxPczGS/s400/Artwork.jpg' },
];
// ランダムに5記事選択（ビルド時に固定）
const shuffled = [...popularArticles].sort(() => Math.random() - 0.5);
const selectedPopular = shuffled.slice(0, 5);
---

<BaseLayout title={page.currentPage === 1 ? "Like a Silicon Valley" : `Page ${page.currentPage}`} isHome={page.currentPage === 1} fullWidth>
  <!-- Hero Section (only on page 1) -->
  {page.currentPage === 1 && (
    <section class="relative overflow-hidden text-white min-h-[420px] sm:min-h-[520px] md:min-h-[600px] flex items-end">
      <!-- Background image -->
      <div class="absolute inset-0">
        <img
          src="/images/hero-bg.png"
          alt="Golden Gate Bridge, San Francisco"
          class="w-full h-full object-cover object-center"
          loading="eager"
        />
      </div>

      <!-- Dark gradient overlay for text readability (bottom heavy, top clear for blue sky) -->
      <div class="absolute inset-0" style="background: linear-gradient(to top, rgb(17 24 39) 0%, rgb(17 24 39 / 0.6) 40%, rgb(17 24 39 / 0.15) 65%, transparent 100%)"></div>
      <div class="absolute inset-0" style="background: linear-gradient(to right, rgb(17 24 39 / 0.4) 0%, transparent 60%)"></div>

      <div class="relative max-w-5xl mx-auto px-4 sm:px-6 py-12 sm:py-16 w-full">
        <div class="max-w-2xl">
          <h1 class="text-3xl sm:text-5xl lg:text-6xl font-extrabold tracking-tight mb-4 sm:mb-6 leading-[1.1] drop-shadow-lg">
            <span class="block text-white">Like a</span>
            <span class="text-white" style="text-shadow: 0 0 30px rgba(9,111,202,0.8), 0 0 60px rgba(94,197,255,0.4), 0 2px 4px rgba(0,0,0,0.5);">Silicon Valley</span>
          </h1>

          <p class="text-sm sm:text-base md:text-lg text-gray-200 leading-relaxed mb-6 sm:mb-8 max-w-xl drop-shadow-md">
            Goodpatchの創業者土屋がサンフランシスコに行く前から起業後の<br class="hidden md:inline" />数年間（2010~2017年）を書き記したブログをまとめたサイトです
          </p>

          <div class="flex flex-wrap gap-3">
            <a href="/archive" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white text-gray-900 font-semibold text-sm hover:bg-gray-100 transition-colors shadow-lg">
              Blog Archive
              <span class="text-xs text-gray-500 font-normal">{totalPosts} articles</span>
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
            <a href="/search" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white/[0.15] border border-white/[0.25] text-white font-semibold text-sm hover:bg-white/[0.25] transition-colors backdrop-blur-sm shadow-lg">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
              Search
            </a>
          </div>
        </div>

      </div>
    </section>
  )}

  <!-- Content -->
  <div class="max-w-5xl mx-auto px-4 sm:px-6 py-12">
    <!-- 人気の記事 (only on page 1) -->
    {page.currentPage === 1 && (
      <section class="mb-12">
        <div class="flex items-center gap-3 mb-6">
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Popular Posts</h2>
          <div class="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-white/10 to-transparent"></div>
        </div>
        <div class="grid gap-4">
          {selectedPopular.map((article) => (
            <article class="group glass rounded-2xl p-4 sm:p-6 gradient-border hover:shadow-glow dark:hover:shadow-glow transition-all duration-300 overflow-hidden">
              <a href={`/posts/${article.slug}`} class="flex gap-4 sm:gap-5">
                <div class="shrink-0 w-20 h-20 sm:w-28 sm:h-28 rounded-xl overflow-hidden">
                  <img
                    src={article.image}
                    alt={article.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    loading="lazy"
                  />
                </div>
                <div class="flex-1 min-w-0 flex flex-col justify-center">
                  <h3 class="text-base sm:text-lg font-bold text-gray-900 dark:text-white group-hover:gradient-text transition-all duration-300 leading-snug line-clamp-2">
                    {article.title}
                  </h3>
                </div>
              </a>
            </article>
          ))}
        </div>
      </section>
    )}

    <!-- Posts -->
    <section>
      <div class="flex items-center gap-3 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
          {page.currentPage === 1 ? 'Recent Posts' : `Posts - Page ${page.currentPage}`}
        </h2>
        <div class="flex-1 h-px bg-gradient-to-r from-gray-200 dark:from-white/10 to-transparent"></div>
      </div>

      <div class="grid gap-4">
        {page.data.map(post => (
          <PostCard
            title={post.data.title}
            date={post.data.date}
            description={post.data.description}
            tags={post.data.tags}
            slug={post.slug}
            source={post.data.source}
          />
        ))}
      </div>

      <Pagination
        currentPage={page.currentPage}
        totalPages={page.lastPage}
        baseUrl="/"
      />
    </section>
  </div>
</BaseLayout>
